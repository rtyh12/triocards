<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <!-- google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Lato&family=Lora:wght@700&family=Outfit:wght@200;300&family=Source+Code+Pro:wght@300&display=swap"
        rel="stylesheet">

    <title>Document</title>
</head>

<body>
    <!-- TODO move scripts into head and use async/defer -->
    <!-- TODO move scripts into their own file -->
    <script src="https://cdn.socket.io/4.4.0/socket.io.min.js"
        integrity="sha384-1fOn6VtTq3PWwfsOrk45LnYcGosJwzMHv+Xh/Jx5303FVOXzEnw0EpLv30mtjmlj" crossorigin="anonymous">
        </script>

    <div id='last-played-card-container'>
    </div>

    <div id='card-container'>
        <div class="card" id="clickme" style="background-color: deepskyblue;">
            <div class="card-inner">ðŸŒ±</div>
        </div>

        <div class="card" id="clickme" style="background-color: rgb(62, 212, 48);">
            <div class="card-inner">ðŸŒ±</div>
        </div>
    </div>

    <script>
        var socket = io();

        // helper functions

        function GetURLParameter(sParam) {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) {
                    return sParameterName[1];
                }
            }
        }

        // game state

        var roomCode = GetURLParameter('roomcode');
        var player_id = undefined;

        document.getElementById("clickme").addEventListener('click', function (e) {
            e.preventDefault();
            socket.emit('click', { id: socket.id, cardClicked: 0 });
        });

        class Card {
            constructor(number, color) {
                this.number = number;
                this.color = color;
            }
        }

        function compareCards(a, b) {
            if (a.number != b.number) {
                return a.number - b.number;
            }
            else if (a.color != b.color) {
                return a.color - b.color;
            }
            else {
                return 0;
            }
        }

        var cards = [];
        var lastPlayed = new Card(-1, 4);

        // network

        function requestState() {
            msg = {
                'roomCode': roomCode,
                'player_id': player_id
            }
            socket.emit('requestState', msg, (response) => {
                console.log(response);
            });
        }

        socket.on("receive_cards", (msg) => {
            console.log(msg);
            new_cards = msg['cards'];

            if (msg['lastPlayed'].number == undefined)
                new_lastPlayed = new Card('hi ðŸ˜Š', 4);
            else
                new_lastPlayed = msg['lastPlayed'];

            // if new and old cards are not the same
            if (JSON.stringify(cards.slice().sort(compareCards)) !== JSON.stringify(new_cards.slice().sort(compareCards))) {
                cards = new_cards;
                renderCards();
            }

            if (new_lastPlayed != lastPlayed) {
                lastPlayed = new_lastPlayed;
                renderLastCard();
            }

            cards = new_cards;
            lastPlayed = new_lastPlayed;
        });

        // rendering

        function lookupColor(color) {
            switch (color) {
                case 0:
                    return 'deepskyblue';
                    break;
                case 1:
                    return 'rgb(62, 212, 48)';
                    break;
                case 2:
                    return 'rgb(236, 33, 77)';
                    break;
                case 3:
                    return 'rgb(252, 214, 0)';
                    break;
                case 4:
                    return 'rgb(0, 0, 0)';
                    break;
            }
        }

        function renderCards() {
            // the rotation angle will be between + and - this value
            let rotationSpread = 20;

            console.log('drawCards() called');
            var newContainer = document.createElement('div');
            var cardContainer = document.getElementById("card-container");
            newContainer.id = 'card-container';

            sortedCards = cards.sort(compareCards);
            console.log('sorted', sortedCards);
            for (let i = 0; i < sortedCards.length; i++) {
                var card_div = document.createElement("div");
                card_div.className = 'card playable';
                card_div.id = 'card' + i;
                card_div.style.backgroundColor = lookupColor(sortedCards[i].color);
                card_div.style.setProperty('--rot', (i + 0.5 - sortedCards.length / 2.0) * 2 * rotationSpread / (sortedCards.length - 1) + 'deg');
                card_div.style.setProperty('--arc-translate', Math.abs(i - sortedCards.length / 2.0) * 6 + 'px');

                var card_inner_div = document.createElement("div");
                card_inner_div.className = 'card-inner';
                card_inner_div.innerHTML = sortedCards[i].number;

                card_div.appendChild(card_inner_div);
                newContainer.appendChild(card_div);

                card_div.addEventListener('click', function (e) {
                    console.log('clicked card', i);
                    e.preventDefault();
                    socket.emit('click', {
                        'player_id': player_id,
                        'roomCode': roomCode,
                        'cardClicked': i
                    });
                });
            }
            cardContainer.replaceWith(newContainer);
        }

        function renderLastCard() {
            // random rotation of last played card
            var lastSpread = 50;
            var x_spread = 60;
            var y_spread = 60;

            // last played card
            var newLastPlayedContainer = document.getElementById("last-played-card-container");
            var lastPlayedContainer = document.getElementById("last-played-card-container");
            newLastPlayedContainer.id = "last-played-card-container";

            var last_card_div = document.createElement("div");
            last_card_div.className = 'card';
            last_card_div.style.backgroundColor = lookupColor(lastPlayed.color);
            last_card_div.style.setProperty('--rot', Math.random() * (2 * lastSpread) - lastSpread + 'deg');
            last_card_div.style.setProperty('--rand_x', Math.random() * x_spread - (1 / 2) * x_spread + 'px');
            last_card_div.style.setProperty('--rand_y', Math.random() * y_spread - (1 / 2) * y_spread + 'px');
            last_card_div.style.position = 'absolute';

            var last_card_inner_div = document.createElement("div");
            last_card_inner_div.className = 'card-inner';
            last_card_inner_div.innerHTML = lastPlayed.number;

            last_card_div.appendChild(last_card_inner_div);
            newLastPlayedContainer.appendChild(last_card_div);
            lastPlayedContainer.replaceWith(newLastPlayedContainer);
        }

        // on page load, keep trying to connect until successful

        function connect() {
            if (socket.id == undefined) {
                return setTimeout(connect, 10);
            }
            socket.emit('requestJoin', {
                'session_id': socket.id,
                'roomCode': roomCode,
            }, (response) => {
                console.log('Connection successful yey');
                player_id = response['player_id'];
                roomCode = response['roomCode'];
            });
        }
        connect();

    </script>
</body>

</html>
